<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laporan Kunjungan Rumah</title>
    <!-- Library untuk Word Generator -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Library untuk PDF Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link rel="stylesheet" href="style.css" />

    <!-- PWA -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#5c6bc0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Laporan KR" />
    <link rel="apple-touch-icon" href="icons/icon-192.svg" />
    <meta name="description" content="Generator Laporan Kunjungan Rumah untuk Kader Puskesmas Balas Klumprik" />
</head>

<body>
    <!-- PWA Install Banner -->
    <div id="installBanner" class="install-banner" style="display: none;">
        <div class="install-banner-content">
            <div class="install-banner-icon">üì≤</div>
            <div class="install-banner-text">
                <strong>Install Aplikasi</strong>
                <span>Pasang di HP untuk akses cepat & offline</span>
            </div>
            <button id="installBtn" class="install-banner-btn">Install</button>
            <button id="installDismiss" class="install-banner-close">&times;</button>
        </div>
    </div>
    <!-- Login Panel -->
    <div id="loginPanel" class="login-panel">
        <div class="login-content">
            <div class="login-title">üîê Login untuk Auto-Save</div>
            <div class="login-form">
                <input type="text" id="usernameInput" placeholder="Masukkan nama Anda..." maxlength="20" />
                <button type="button" id="loginBtn" class="btn-login">Masuk</button>
            </div>
            <div class="login-note">Data akan otomatis tersimpan & expired setelah 3 hari</div>
            <div id="authMessage" class="auth-message" style="display: none;"></div>
        </div>
    </div>

    <!-- User Info Bar (shown when logged in) -->
    <div id="userInfo" class="user-info-bar" style="display: none;">
        <div class="user-info-content">
            <span class="user-label">üë§ Login sebagai: <strong id="usernameDisplay"></strong></span>
            <div class="user-actions">
                <button id="btnSettings" class="btn-logout" title="Settings">‚öôÔ∏è</button>
                <button id="btnSaveData" class="btn-save">Simpan Data</button>
                <button id="btnLogout" class="btn-logout">Logout</button>
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <!-- Form Container -->
        <div class="form-container">
            <div class="container">
                <h1>
                    GENERATOR LAPORAN KUNJUNGAN RUMAH<br />PUSKESMAS BALAS KLUMPRIK
                </h1>

                <form id="laporanForm">
                    <!-- Opsi Jumlah Laporan -->
                    <div class="form-group">
                        <label for="jumlahLaporan">Jumlah Laporan dalam 1 Dokumen:</label>
                        <select id="jumlahLaporan" required>
                            <option value="1" selected>1 Laporan</option>
                            <option value="2">2 Laporan</option>
                            <option value="3">3 Laporan</option>
                            <option value="4">4 Laporan</option>
                            <option value="5">5 Laporan</option>
                            <option value="6">6 Laporan</option>
                            <option value="7">7 Laporan</option>
                            <option value="8">8 Laporan</option>
                            <option value="9">9 Laporan</option>
                            <option value="10">10 Laporan</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="bulan">Bulan Laporan:</label>
                                <select id="bulan" required>
                                    <option value="">Pilih Bulan</option>
                                    <option value="JANUARI">Januari</option>
                                    <option value="FEBRUARI">Februari</option>
                                    <option value="MARET">Maret</option>
                                    <option value="APRIL">April</option>
                                    <option value="MEI">Mei</option>
                                    <option value="JUNI">Juni</option>
                                    <option value="JULI">Juli</option>
                                    <option value="AGUSTUS">Agustus</option>
                                    <option value="SEPTEMBER">September</option>
                                    <option value="OKTOBER">Oktober</option>
                                    <option value="NOVEMBER">November</option>
                                    <option value="DESEMBER">Desember</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="tahun">Tahun Laporan:</label>
                                <input type="number" id="tahun" min="2020" max="2030" required />
                            </div>
                        </div>
                    </div>

                    <!-- Container untuk form laporan yang akan di-generate dinamis -->
                    <div id="laporanContainer">
                        <!-- Form laporan pertama (default) -->
                        <div class="laporan-section" data-laporan="1">
                            <h3 class="laporan-title">Laporan 1</h3>

                            <div class="form-group">
                                <label for="tanggal_1">Tanggal:</label>
                                <input type="date" id="tanggal_1" name="tanggal_1" required />
                            </div>

                            <!-- Kategori Usia -->
                            <div class="form-group">
                                <label for="kategori_1">Kategori Usia:</label>
                                <select id="kategori_1" name="kategori_1" required>
                                    <option value="">Pilih Kategori</option>
                                    <option value="balita">Balita (0-5 tahun)</option>
                                    <option value="dewasa">Dewasa (>5 tahun)</option>
                                </select>
                            </div>

                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <label for="nama_1">Nama:</label>
                                        <input type="text" id="nama_1" name="nama_1" required />
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <label for="usia_1">Usia:</label>
                                        <input type="text" id="usia_1" name="usia_1" required
                                            placeholder="Contoh: 24, 10bulan, 3,5thn, 1thn 3bulan" />
                                        <div class="input-help">
                                            Format fleksibel: angka saja (auto-detect), angka+satuan (bulan/thn/tahun),
                                            atau kombinasi (1thn 3bulan)
                                        </div>
                                        <div id="usiaParsed_1" class="parsed-result"></div>
                                        <div id="usiaError_1" class="error-message"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="alamat_1">Alamat:</label>
                                <input type="text" id="alamat_1" name="alamat_1" required />
                            </div>

                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <label for="beratBadan_1">Berat Badan (kg):</label>
                                        <input type="number" step="0.1" id="beratBadan_1" name="beratBadan_1"
                                            required />
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <label for="tinggiBadan_1">Tinggi Badan (cm):</label>
                                        <input type="number" id="tinggiBadan_1" name="tinggiBadan_1" required />
                                    </div>
                                </div>
                            </div>

                            <!-- Field khusus balita (hidden by default) -->
                            <div class="balita-fields" id="balitaFields_1" style="display: none">
                                <div class="form-group">
                                    <label>Pilih Jenis Pengukuran (bisa pilih lebih dari 1):</label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="lilaBalitaCheck_1" name="pengukuranBalita_1"
                                                value="lila" />
                                            <label for="lilaBalitaCheck_1">LILA - Lingkar Lengan Atas</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="likaBalitaCheck_1" name="pengukuranBalita_1"
                                                value="lika" />
                                            <label for="likaBalitaCheck_1">LIKA - Lingkar Kepala</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="lingkarPerutBalitaCheck_1"
                                                name="pengukuranBalita_1" value="lingkarPerut" />
                                            <label for="lingkarPerutBalitaCheck_1">Lingkar Perut</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="pengukuran-option" id="lilaBalitaOption_1" style="display: none">
                                    <div class="form-group">
                                        <label for="lila_1">LILA - Lingkar Lengan Atas (cm):</label>
                                        <input type="number" step="0.1" id="lila_1" name="lila_1" />
                                    </div>
                                </div>
                                <div class="pengukuran-option" id="likaBalitaOption_1" style="display: none">
                                    <div class="form-group">
                                        <label for="lika_1">LIKA - Lingkar Kepala (cm):</label>
                                        <input type="number" step="0.1" id="lika_1" name="lika_1" />
                                    </div>
                                </div>
                                <div class="pengukuran-option" id="lingkarPerutBalitaOption_1" style="display: none">
                                    <div class="form-group">
                                        <label for="lingkarPerut_1">Lingkar Perut (cm):</label>
                                        <input type="number" id="lingkarPerut_1" name="lingkarPerut_1" />
                                    </div>
                                </div>
                            </div>

                            <!-- Field khusus dewasa (hidden by default) -->
                            <div class="dewasa-fields" id="dewasaFields_1" style="display: none">
                                <div class="form-group">
                                    <label>Pilih Jenis Pengukuran (bisa pilih lebih dari 1):</label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="lilaDewasaCheck_1" name="pengukuranDewasa_1"
                                                value="lila" />
                                            <label for="lilaDewasaCheck_1">LILA - Lingkar Lengan Atas</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="lingkarPinggangDewasaCheck_1"
                                                name="pengukuranDewasa_1" value="lingkarPinggang" />
                                            <label for="lingkarPinggangDewasaCheck_1">Lingkar Pinggang</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="pengukuran-option" id="lilaDewasaOption_1" style="display: none">
                                    <div class="form-group">
                                        <label for="lilaD_1">LILA - Lingkar Lengan Atas (cm):</label>
                                        <input type="number" step="0.1" id="lilaD_1" name="lilaD_1" />
                                    </div>
                                </div>
                                <div class="pengukuran-option" id="lingkarPinggangDewasaOption_1" style="display: none">
                                    <div class="form-group">
                                        <label for="lingkarPinggang_1">Lingkar Pinggang (cm):</label>
                                        <input type="number" step="0.1" id="lingkarPinggang_1"
                                            name="lingkarPinggang_1" />
                                    </div>
                                </div>
                            </div>

                            <!-- Tensi (conditional: tidak tampil untuk balita) -->
                            <div class="form-group" id="tensiGroup_1">
                                <label for="tensi_1">Tensi:</label>
                                <input type="text" id="tensi_1" name="tensi_1" placeholder="contoh: 120/80" required />
                            </div>

                            <div class="form-group">
                                <label for="keluhan_1">Keluhan / Permasalahan:</label>
                                <textarea id="keluhan_1" name="keluhan_1" required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="tindakLanjut_1">Tindak Lanjut:</label>
                                <textarea id="tindakLanjut_1" name="tindakLanjut_1" required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="kader_1">Kader yang melakukan kunjungan rumah:</label>
                                <input type="text" id="kader_1" name="kader_1" required />
                            </div>

                            <div class="form-group">
                                <label for="foto_1">Foto Geotag (opsional):</label>
                                <div class="drop-zone" id="dropZone_1">
                                    <div class="drop-zone-content">
                                        <div class="upload-icon">üì∑</div>
                                        <p>
                                            <strong>Drag & Drop foto di sini</strong><br />atau klik untuk memilih file
                                        </p>
                                        <p class="paste-hint">üí° Ctrl+V untuk paste foto dari WhatsApp</p>
                                        <p class="file-types">
                                            Format: JPG, PNG, JPEG (Max 10MB)
                                        </p>
                                    </div>
                                    <input type="file" id="foto_1" name="foto_1" accept="image/*"
                                        style="display: none" />
                                </div>
                                <div class="file-info">
                                    Foto akan dikompres otomatis (max 1200px, ‚â§300KB)
                                </div>
                                <div class="photo-preview" id="photoPreview_1"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress-container" id="progressContainer" style="display: none">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">
                            Memulai proses...
                        </div>
                        <div class="progress-percentage" id="progressPercentage">0%</div>
                    </div>

                    <div class="loading" id="loading" style="display: none">
                        Memproses foto dan membuat dokumen...
                    </div>
                    <div class="success" id="success" style="display: none">
                        ‚úÖ Dokumen berhasil dibuat dan didownload!
                    </div>

                    <!-- Tombol Generate dengan Dropdown -->
                    <div class="button-group">
                        <button type="submit" id="generateBtn" class="btn-primary">
                            üìÑ Generate Word (.docx)
                        </button>
                        <button type="button" id="generatePdfBtn" class="btn-secondary">
                            üìë Generate PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel" id="previewPanel">
            <div class="preview-header">
                <h3>Preview PDF</h3>
                <button type="button" class="btn-close-preview" id="closePreview">
                    ‚úï
                </button>
            </div>
            <div class="preview-content" id="previewContent">
                <p style="text-align: center; color: #999; padding: 20px">
                    Isi form untuk melihat preview
                </p>
            </div>
        </div>

        <!-- Toggle Preview Button -->
        <button type="button" class="btn-toggle-preview" id="togglePreview">
            üëÅÔ∏è Preview PDF
        </button>
    </div>

    <!-- Floating WhatsApp Button -->
    <div class="whatsapp-float" id="whatsappFloat">
        <div class="whatsapp-icon">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="white">
                <path
                    d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.46 3.516" />
            </svg>
        </div>
        <div class="whatsapp-tooltip">Hubungi Developer</div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <div class="modal-content">
            <span class="close-btn" onclick="closeImageModal()">&times;</span>
            <img id="modalImage" src="" alt="Preview" />
        </div>
    </div>

    <!-- QRIS Modal (Support Developer) -->
    <div id="qrisModal" class="qris-modal">
        <div class="qris-overlay" onclick="closeQrisModal()"></div>
        <div class="qris-card">
            <button class="qris-close-x" onclick="closeQrisModal()">√ó</button>
            <h3 class="qris-title">Dukung Developer</h3>
            <p class="qris-subtitle">Scan QRIS untuk memberikan dukungan</p>
            <img src="qris.jpg" alt="QRIS Support" class="qris-img" />
            <button class="qris-close-btn" onclick="closeQrisModal()">Tutup</button>
        </div>
    </div>

    <!-- Include Footer -->
    <iframe id="footerFrame" src="footer.html" scrolling="no"
        style="width: 100%; height: 130px; border: none; display: block; overflow: hidden;"></iframe>

    <script>
        // QRIS Modal Functions
        function openQrisModal() {
            document.getElementById('qrisModal').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeQrisModal() {
            document.getElementById('qrisModal').classList.remove('open');
            document.body.style.overflow = '';
        }

        // Listen for messages from footer iframe
        window.addEventListener('message', function (event) {
            if (event.data === 'openQris') {
                openQrisModal();
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeQrisModal();
            }
        });
    </script>

    <!-- Load Scripts -->
    <!-- AI Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>‚öôÔ∏è Pengaturan Suara AI</h2>
            <div class="modal-body">
                <p>Nyalakan <b>Hybrid AI Correction</b> untuk hasil teks yang jauh lebih akurat (memperbaiki tata bahasa
                    & istilah medis otomatis).</p>

                <div class="form-group">
                    <label for="aiToggle">Status:</label>
                    <label class="switch">
                        <input type="checkbox" id="aiToggle">
                        <span class="slider round"></span>
                    </label>
                    <span id="aiStatusText">Non-aktif</span>
                </div>

                <div class="form-group" id="apiKeyGroup" style="display:none">
                    <label for="groqKey">Groq API Key (Gratis):</label>
                    <input type="password" id="groqKey" placeholder="gsk_..." autocomplete="off">
                    <p class="input-help">Dapatkan key gratis di <a href="https://console.groq.com/keys"
                            target="_blank">console.groq.com</a></p>
                </div>

                <div class="form-group">
                    <button id="saveSettings" class="btn-primary">Simpan Pengaturan</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="stylepdf.js"></script>
    <script src="auth.js"></script>
    <script src="voice.js?v=9.5"></script>

    <script>
        // Initialize auth system after all scripts loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Init auth
            if (typeof AuthSystem !== 'undefined') {
                AuthSystem.init();
            }

            // ===== PWA: Register Service Worker =====
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('‚úÖ Service Worker registered', reg.scope))
                    .catch(err => console.warn('SW registration failed:', err));
            }

            // ===== PWA: Install Prompt =====
            let deferredPrompt;
            const installBanner = document.getElementById('installBanner');
            const installBtn = document.getElementById('installBtn');
            const installDismiss = document.getElementById('installDismiss');

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // Show install banner
                if (installBanner && !localStorage.getItem('pwa_install_dismissed')) {
                    installBanner.style.display = 'block';
                    setTimeout(() => installBanner.classList.add('show'), 100);
                }
            });

            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log('Install outcome:', outcome);
                        deferredPrompt = null;
                        installBanner.style.display = 'none';
                    }
                });
            }

            if (installDismiss) {
                installDismiss.addEventListener('click', () => {
                    installBanner.classList.remove('show');
                    setTimeout(() => installBanner.style.display = 'none', 300);
                    localStorage.setItem('pwa_install_dismissed', 'true');
                });
            }

            window.addEventListener('appinstalled', () => {
                console.log('‚úÖ App installed!');
                installBanner.style.display = 'none';
            });

            // Login button
            const loginBtn = document.getElementById('loginBtn');
            const usernameInput = document.getElementById('usernameInput');

            if (loginBtn) {
                loginBtn.addEventListener('click', function () {
                    const username = usernameInput.value.trim();
                    if (!username) {
                        AuthSystem.showMessage('Masukkan nama Anda!', true);
                        return;
                    }
                    const result = AuthSystem.login(username);
                    AuthSystem.showMessage(result.message, !result.success);
                    if (result.success) {
                        AuthSystem.updateUI();
                    }
                });
            }

            // Enter key to login
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        loginBtn.click();
                    }
                });
            }

            // Save button
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', async function () {
                    saveBtn.disabled = true;
                    saveBtn.textContent = '‚è≥ Menyimpan...';
                    const result = await AuthSystem.save();
                    AuthSystem.showMessage(result.message, !result.success);
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Simpan';
                });
            }

            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function () {
                    // Save before logout
                    await AuthSystem.save();
                    const result = AuthSystem.logout();
                    AuthSystem.showMessage(result.message, !result.success);
                    AuthSystem.updateUI();
                    // Reload page to clear form
                    setTimeout(() => location.reload(), 1500);
                });
            }

            // Auto-save on form change (debounced)
            let saveTimeout;
            document.getElementById('laporanForm')?.addEventListener('change', function () {
                if (AuthSystem.getCurrentUser()) {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(async () => {
                        await AuthSystem.save();
                    }, 5000); // Auto save after 5 seconds of no changes
                }
            });
        });
    </script>
</body>

</html>